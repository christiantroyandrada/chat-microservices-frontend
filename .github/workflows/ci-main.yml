name: ci - master
on:
  # Run this workflow when changes are pushed to the main branch
  # (post-PR merge / direct pushes to main)
  push:
    branches: [main, master]

jobs:
  build-and-sonar:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        # Pinned to specific commit SHA for supply-chain security
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Setup Node.js
        # Pinned to specific commit SHA for supply-chain security
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: '22'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install frontend deps
        working-directory: ./
        run: pnpm install

      - name: npm/pnpm audit (dependency vulnerability check)
        working-directory: ./
        run: |
          # Try pnpm audit first; fall back to npm audit for compatibility
          pnpm audit --audit-level=moderate || npm audit --audit-level=moderate || true

      - name: Lint (Prettier + ESLint)
        working-directory: ./
        run: pnpm run lint

      - name: TypeScript type check
        working-directory: ./
        run: pnpm exec tsc --noEmit

      - name: Svelte check
        working-directory: ./
        run: pnpm run check

      - name: Build FE (prepare + build)
        working-directory: ./
        run: |
          pnpm run prepare || true
          pnpm run build

      - name: Ensure Playwright browsers are installed
        working-directory: ./
        run: pnpm exec playwright install

      - name: Ensure coverage temp directory exists
        working-directory: ./
        run: mkdir -p coverage/.tmp

      - name: Run unit tests and generate coverage
        working-directory: ./
        run: pnpm run coverage:unit
        timeout-minutes: 15

      - name: Check Sonar secrets/vars
        working-directory: ./
        run: |
          if [ -z "$SONAR_TOKEN" ]; then
            echo "::error::SONAR_TOKEN is not set. Add it under Settings â†’ Secrets and variables â†’ Actions.";
            exit 1;
          fi
          if [ -z "$SONAR_ORGANIZATION_SECRET" ] && [ -z "$SONAR_ORGANIZATION_VAR" ]; then
            echo "::error::SONAR_ORGANIZATION is not set as a secret or variable. Add it under Settings â†’ Secrets and variables â†’ Actions.";
            exit 1;
          fi
          echo "Sonar secrets/vars present. Proceeding..."
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_ORGANIZATION_SECRET: ${{ secrets.SONAR_ORGANIZATION }}
          SONAR_ORGANIZATION_VAR: ${{ vars.SONAR_ORGANIZATION }}

      - name: SonarCloud Scan
        # Pinned to specific commit SHA for supply-chain security
        uses: SonarSource/sonarqube-scan-action@fd88b7d7ccbaefd23d8f36f73b59db7a3d246602
        with:
          args: >
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }}
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
            -Dsonar.exclusions=tests/**,test/**,__mocks__/**,mocks/**
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}

  # Deploy to VPS (only runs on main branch after build and tests pass)
  deploy:
    name: Deploy Frontend to VPS
    needs: build-and-sonar
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: http://${{ secrets.VPS_HOST }}
    concurrency:
      group: production-frontend-deployment
      cancel-in-progress: false

    steps:
      - name: Deploy Frontend via SSH
        uses: appleboy/ssh-action@029f5b4aeeeb58fdfe1410a5d17f967dacf36262
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          port: ${{ secrets.VPS_PORT || '22' }}
          command_timeout: 20m
          script: |
            set -e
            export DEPLOY_PATH="${{ secrets.DEPLOY_PATH || '/opt/chat-app' }}"

            echo "ğŸš€ Starting frontend deployment..."

            # Pull latest frontend changes
            cd $DEPLOY_PATH/chat-microservices-frontend
            git fetch origin
            git reset --hard origin/main

            # Rebuild and restart the frontend service
            cd $DEPLOY_PATH/chat-microservices
            echo "ğŸ—ï¸  Building frontend service..."
            docker compose -f docker-compose.yml -f docker-compose.prod.yml build frontend

            echo "ğŸ”„ Restarting frontend service..."
            docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d frontend

            # Wait for service to be healthy
            echo "â³ Waiting for frontend to be healthy..."
            sleep 15

            # Verify frontend is running
            if docker compose ps frontend | grep -q "healthy"; then
              echo "âœ… Frontend is healthy"
              
              # Restart nginx to ensure it picks up frontend changes
              echo "ğŸ”„ Restarting nginx..."
              docker compose restart nginx
              sleep 5
              
              # Test frontend through nginx
              if curl -f http://localhost:85/ > /dev/null 2>&1; then
                echo "âœ… Frontend accessible through nginx"
                echo "ğŸ‰ Frontend deployment successful!"
              else
                echo "âš ï¸  Frontend is running but not accessible through nginx"
                docker compose logs nginx --tail=20
              fi
            else
              echo "âŒ Frontend deployment failed"
              echo "ğŸ“‹ Service status:"
              docker compose ps frontend
              echo "ğŸ“ Frontend logs:"
              docker compose logs frontend --tail=50
              exit 1
            fi
